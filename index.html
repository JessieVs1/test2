<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Bestel App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans p-4">
  <div id="app" class="max-w-4xl mx-auto">
    <!-- Startscherm -->
    <div id="start-screen" class="text-center">
      <h1 class="text-3xl font-bold mb-8">Welkom bij de Bestel App</h1>
      <button onclick="openOrderPopup()" class="bg-blue-500 text-white px-6 py-2 rounded mr-4">Bestellen</button>
      <button onclick="openAdminPopup()" class="bg-gray-700 text-white px-6 py-2 rounded">Beheer</button>
    </div>

    <!-- Overige schermen -->
    <div id="order-screen" class="hidden"></div>
    <div id="admin-screen" class="hidden"></div>
  </div>

  <!-- Pop-ups -->
  <div id="popup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded shadow-md w-80 text-center">
      <h2 class="text-xl font-semibold mb-4" id="popup-title">Code invoeren</h2>
      <input id="popup-input" type="text" placeholder="Code" class="w-full border px-2 py-1 mb-4 rounded" />
      <div>
        <button onclick="confirmPopup()" class="bg-blue-600 text-white px-4 py-1 rounded mr-2">OK</button>
        <button onclick="closePopup()" class="bg-gray-400 text-white px-4 py-1 rounded">Annuleer</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase setup
    const supabaseUrl = 'https://nsevcinmxmaplnpyctht.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZXZjaW5teG1hcGxucHljdGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYyOTkxOTAsImV4cCI6MjA2MTg3NTE5MH0.-GrwWMhWxXXZM2zL3S_Zat7GhpvbgEBzBGpKzhy-rcU';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const ADMIN_CODE = 'Admin123';
    let currentUser = null;
    let cart = [];

    let popupCallback = null;

    function openAdminPopup() {
      showPopup("Voer admincode in", async (code) => {
        if (code === ADMIN_CODE) {
          loadAdminScreen();
        } else {
          alert("Ongeldige admincode");
        }
      });
    }

    function openOrderPopup() {
      showPopup("Voer gebruikerscode in", async (code) => {
        const { data: user, error } = await supabase
          .from('users')
          .select('*')
          .eq('code', code)
          .single();

        if (user) {
          currentUser = user;
          loadOrderScreen();
        } else {
          alert("Gebruiker niet gevonden");
        }
      });
    }

    function showPopup(title, callback) {
      document.getElementById('popup-title').innerText = title;
      document.getElementById('popup-input').value = '';
      document.getElementById('popup').classList.remove('hidden');
      popupCallback = callback;
    }

    function closePopup() {
      document.getElementById('popup').classList.add('hidden');
    }

    async function confirmPopup() {
      const value = document.getElementById('popup-input').value;
      closePopup();
      if (popupCallback) await popupCallback(value);
    }

    function showScreen(id) {
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('order-screen').classList.add('hidden');
      document.getElementById('admin-screen').classList.add('hidden');
      document.getElementById(id).classList.remove('hidden');
    }

    function backToStart() {
      showScreen('start-screen');
      currentUser = null;
      cart = [];
    }

    async function loadOrderScreen() {
      showScreen('order-screen');
      const screen = document.getElementById('order-screen');
      screen.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Welkom, ${currentUser.name}</h2>
        <div id="product-grid" class="grid grid-cols-2 gap-4"></div>
        <h3 class="text-xl font-semibold mt-6 mb-2">Winkelwagen</h3>
        <ul id="cart-list" class="bg-white p-4 rounded shadow mb-4"></ul>
        <button onclick="submitOrder()" class="bg-green-600 text-white px-4 py-2 rounded">Bestelling bevestigen</button>
        <button onclick="backToStart()" class="mt-4 bg-gray-400 text-white px-4 py-1 rounded">Terug</button>
      `;
      const { data: products } = await supabase.from('products').select('*');
      const grid = document.getElementById('product-grid');
      products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded shadow';
        card.innerHTML = `
          <h3 class="text-lg font-semibold">${p.name}</h3>
          <p>Prijs: €${p.price.toFixed(2)}</p>
          <p>Voorraad: ${p.stock}</p>
          <button onclick='addToCart("${p.id}", "${p.name}", ${p.price}, ${p.stock})' class="mt-2 bg-blue-500 text-white px-3 py-1 rounded">Toevoegen</button>
        `;
        grid.appendChild(card);
      });
    }

    function addToCart(id, name, price, stock) {
      const existing = cart.find(p => p.id === id);
      if (existing) {
        if (existing.quantity + 1 > stock) {
          alert("Niet genoeg voorraad!");
          return;
        }
        existing.quantity++;
      } else {
        cart.push({ id, name, price, quantity: 1 });
      }
      updateCartUI();
      alert(`${name} toegevoegd aan winkelwagen`);
    }

    function updateCartUI() {
      const list = document.getElementById('cart-list');
      list.innerHTML = '';
      cart.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name} x${item.quantity} = €${(item.quantity * item.price).toFixed(2)}`;
        list.appendChild(li);
      });
    }

    async function submitOrder() {
      if (cart.length === 0) {
        alert("Winkelwagen is leeg!");
        return;
      }

      const { data: order } = await supabase
        .from('orders')
        .insert({ user_id: currentUser.id })
        .select()
        .single();

      for (let item of cart) {
        await supabase.from('order_items').insert({
          order_id: order.id,
          product_id: item.id,
          quantity: item.quantity,
          price: item.price
        });

        await supabase.rpc('decrement_stock', { pid: item.id, qty: item.quantity });
      }

      alert("Bestelling geplaatst!");
      cart = [];
      updateCartUI();
      loadOrderScreen();
    }

    async function loadAdminScreen() {
      showScreen('admin-screen');
      const screen = document.getElementById('admin-screen');
      screen.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Beheer</h2>
        <button onclick="showUsers()" class="bg-blue-600 text-white px-4 py-2 rounded mb-2">Gebruikers beheren</button><br>
        <button onclick="showProducts()" class="bg-blue-600 text-white px-4 py-2 rounded mb-2">Voorraad beheren</button><br>
        <button onclick="showOrders()" class="bg-blue-600 text-white px-4 py-2 rounded mb-2">Bestelgeschiedenis</button><br>
        <button onclick="addProductForm()" class="bg-green-600 text-white px-4 py-2 rounded mb-2">Nieuw product toevoegen</button><br>
        <button onclick="backToStart()" class="mt-4 bg-gray-400 text-white px-4 py-1 rounded">Terug</button>
        <div id="admin-content" class="mt-6"></div>
      `;
    }

    async function showUsers() {
      const { data: users } = await supabase.from('users').select('*');
      const div = document.getElementById('admin-content');
      div.innerHTML = '<h3 class="text-xl font-semibold mb-2">Gebruikers</h3>';
      users.forEach(u => {
        div.innerHTML += `<p>${u.name} (${u.code})</p>`;
      });
    }

    async function showProducts() {
      const { data: products } = await supabase.from('products').select('*');
      const div = document.getElementById('admin-content');
      div.innerHTML = '<h3 class="text-xl font-semibold mb-2">Voorraad</h3>';
      products.forEach(p => {
        div.innerHTML += `<p>${p.name} - voorraad: ${p.stock}</p>`;
      });
    }

    async function showOrders() {
      const { data: orders } = await supabase
        .from('orders')
        .select('id, created_at, user_id, users(name), order_items(quantity, price, product_id, products(name))');

      const div = document.getElementById('admin-content');
      div.innerHTML = '<h3 class="text-xl font-semibold mb-2">Bestelgeschiedenis</h3>';
      orders.forEach(o => {
        const totaal = o.order_items.reduce((t, i) => t + i.quantity * i.price, 0);
        div.innerHTML += `<p><strong>${o.users.name}</strong> - €${totaal.toFixed(2)}</p>`;
      });
    }

    function addProductForm() {
      const div = document.getElementById('admin-content');
      div.innerHTML = `
        <h3 class="text-xl font-semibold mb-2">Nieuw product</h3>
        <input id="new-name" placeholder="Naam" class="border px-2 py-1 mb-2 block w-full" />
        <input id="new-price" type="number" placeholder="Prijs" class="border px-2 py-1 mb-2 block w-full" />
        <input id="new-stock" type="number" placeholder="Voorraad" class="border px-2 py-1 mb-2 block w-full" />
        <button onclick="saveProduct()" class="bg-green-600 text-white px-4 py-2 rounded">Opslaan</button>
      `;
    }

    async function saveProduct() {
      const name = document.getElementById('new-name').value;
      const price = parseFloat(document.getElementById('new-price').value);
      const stock = parseInt(document.getElementById('new-stock').value);
      if (!name || isNaN(price) || isNaN(stock)) {
        alert("Ongeldige invoer");
        return;
      }
      await supabase.from('products').insert({ name, price, stock });
      alert("Product toegevoegd!");
      showProducts();
    }
  </script>
</body>
</html>
