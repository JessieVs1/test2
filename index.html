<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestel App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div id="app" class="min-h-screen flex flex-col items-center justify-center p-6"></div>

  <script>
    // Supabase init
    const SUPABASE_URL = "https://nsevcinmxmaplnpyctht.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZXZjaW5teG1hcGxucHljdGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYyOTkxOTAsImV4cCI6MjA2MTg3NTE5MH0.-GrwWMhWxXXZM2zL3S_Zat7GhpvbgEBzBGpKzhy-rcU";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const app = document.getElementById("app");

    let currentUser = null;
    let cart = [];

    const clearApp = () => (app.innerHTML = "");

    function showAlert(msg) {
      alert(msg);
    }

    function startScreen() {
      clearApp();
      app.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Welkom bij de Bestel App</h1>
        <div class="space-x-4">
          <button id="orderBtn" class="px-4 py-2 bg-blue-500 text-white rounded">Bestellen</button>
          <button id="adminBtn" class="px-4 py-2 bg-gray-700 text-white rounded">Beheer</button>
        </div>
      `;
      document.getElementById("adminBtn").onclick = () => {
        const code = prompt("Voer de admin code in:");
        if (code === "Admin123") {
          adminScreen();
        } else {
          showAlert("Ongeldige code.");
        }
      };

      document.getElementById("orderBtn").onclick = async () => {
        const code = prompt("Voer jouw gebruikerscode in:");
        let { data: user } = await supabase.from("users").select("*").eq("code", code).single();
        if (user) {
          currentUser = user;
          orderScreen();
        } else {
          showAlert("Gebruiker niet gevonden.");
        }
      };
    }

    async function orderScreen() {
      clearApp();
      let { data: products } = await supabase.from("products").select("*");

      app.innerHTML = `
        <div class="flex justify-between items-center w-full mb-4">
          <h2 class="text-2xl font-semibold">Welkom ${currentUser.name}</h2>
          <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="startScreen()">Terug</button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 w-full">
          ${products
            .map(
              (p) => `
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-bold">${p.name}</h3>
              <p>Prijs: €${p.price.toFixed(2)}</p>
              <p>Voorraad: ${p.stock}</p>
              <button class="mt-2 bg-green-500 text-white px-2 py-1 rounded" onclick="addToCart(${p.id})">Bestel</button>
            </div>
          `
            )
            .join("")}
        </div>
        <div class="mt-6">
          <button class="bg-yellow-500 px-4 py-2 text-white rounded" onclick="reviewCart()">Winkelwagen (${cart.length})</button>
        </div>
      `;
    }

    async function addToCart(productId) {
      let { data: product } = await supabase.from("products").select("*").eq("id", productId).single();
      if (!product || product.stock <= 0) return showAlert("Product niet op voorraad!");

      cart.push(product);
      showAlert(`${product.name} toegevoegd aan winkelwagen.`);
    }

    function reviewCart() {
      clearApp();
      if (cart.length === 0) {
        showAlert("Winkelwagen is leeg!");
        return orderScreen();
      }

      let grouped = {};
      cart.forEach((item) => {
        if (!grouped[item.id]) grouped[item.id] = { ...item, quantity: 0 };
        grouped[item.id].quantity++;
      });

      let total = Object.values(grouped).reduce((sum, item) => sum + item.price * item.quantity, 0);

      app.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Winkelwagen</h2>
        <ul class="mb-4">
          ${Object.values(grouped)
            .map(
              (item) => `<li>${item.name} - ${item.quantity} x €${item.price.toFixed(2)}</li>`
            )
            .join("")}
        </ul>
        <p class="mb-4 font-bold">Totaal: €${total.toFixed(2)}</p>
        <button onclick="confirmOrder()" class="bg-green-600 text-white px-4 py-2 rounded mr-2">Bevestigen</button>
        <button onclick="orderScreen()" class="bg-gray-500 text-white px-4 py-2 rounded">Terug</button>
      `;
    }

    async function confirmOrder() {
      const updates = {};
      for (let item of cart) {
        updates[item.id] = (updates[item.id] || 0) + 1;
      }

      for (let [id, qty] of Object.entries(updates)) {
        let { data: product } = await supabase.from("products").select("*").eq("id", id).single();
        if (product.stock < qty) {
          showAlert(`Te weinig voorraad voor ${product.name}.`);
          return;
        }
      }

      for (let [id, qty] of Object.entries(updates)) {
        await supabase
          .from("products")
          .update({ stock: supabase.rpc('decrement_stock', { pid: id, amount: qty }) })
          .eq("id", id);
      }

      await supabase.from("orders").insert({
        user_id: currentUser.id,
        items: cart.map((p) => p.name).join(", "),
        total: cart.reduce((sum, p) => sum + p.price, 0),
      });

      cart = [];
      showAlert("Bestelling geplaatst!");
      orderScreen();
    }

    async function adminScreen() {
      clearApp();
      app.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Beheer</h2>
        <div class="space-y-2">
          <button onclick="showUsers()" class="w-full bg-blue-600 text-white py-2 rounded">Gebruikers beheren</button>
          <button onclick="showProducts()" class="w-full bg-green-600 text-white py-2 rounded">Voorraad beheren</button>
          <button onclick="showOrders()" class="w-full bg-yellow-600 text-white py-2 rounded">Bestelgeschiedenis</button>
          <button onclick="addProduct()" class="w-full bg-purple-600 text-white py-2 rounded">Product toevoegen</button>
          <button onclick="startScreen()" class="w-full bg-gray-600 text-white py-2 rounded">Terug</button>
        </div>
      `;
    }

    async function showOrders() {
      clearApp();
      const { data } = await supabase.from("orders").select("*, users(name)").order("user_id");
      app.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Bestelgeschiedenis</h2>
        <ul class="mb-4">
          ${data
            .map(
              (o) =>
                `<li><strong>${o.users.name}:</strong> ${o.items} (€${o.total.toFixed(2)})</li>`
            )
            .join("")}
        </ul>
        <button onclick="clearLogs()" class="bg-red-600 text-white px-4 py-2 rounded">Logs wissen</button>
        <button onclick="adminScreen()" class="ml-2 bg-gray-500 text-white px-4 py-2 rounded">Terug</button>
      `;
    }

    function clearLogs() {
      if (confirm("Weet je zeker dat je de logs wilt wissen?")) {
        supabase.from("orders").delete().neq("id", 0);
        showAlert("Logs verwijderd.");
        adminScreen();
      }
    }

    function showUsers() {
      // Implementatie gebruikerbeheer (toevoegen, wijzigen, verwijderen) kan hier verder worden uitgebreid
      showAlert("Gebruikerbeheer UI hier verder uitbreiden.");
      adminScreen();
    }

    function showProducts() {
      // Implementatie voorraadbeheer
      showAlert("Voorraadbeheer UI hier verder uitbreiden.");
      adminScreen();
    }

    function addProduct() {
      const name = prompt("Naam van product:");
      const price = parseFloat(prompt("Prijs:"));
      const stock = parseInt(prompt("Voorraad:"), 10);
      if (name && !isNaN(price) && !isNaN(stock)) {
        supabase.from("products").insert({ name, price, stock });
        showAlert("Product toegevoegd.");
        adminScreen();
      } else {
        showAlert("Ongeldige invoer.");
      }
    }

    startScreen();
  </script>
</body>
</html>
