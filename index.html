<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Koelkast App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .hidden { display: none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .card { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    button { padding: 8px 12px; margin: 5px; }
    .popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
             background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
             align-items: center; }
    .popup-content { background: white; padding: 20px; border-radius: 10px; }
  </style>
</head>
<body>

<div id="start-screen">
  <h1>Welkom bij de Koelkast App</h1>
  <button onclick="showPopup('beheer')">Beheer</button>
  <button onclick="showPopup('bestellen')">Bestellen</button>
</div>

<div id="popup" class="popup hidden">
  <div class="popup-content">
    <p id="popup-text">Voer je code in:</p>
    <input type="text" id="popup-input">
    <button onclick="handlePopupSubmit()">OK</button>
  </div>
</div>

<div id="bestel-screen" class="hidden">
  <h2>Bestellen</h2>
  <div class="grid" id="product-grid"></div>
  <h3>Winkelwagentje</h3>
  <ul id="cart-list"></ul>
  <button onclick="adjustOrder()">Aanpassen</button>
  <button onclick="confirmOrder()">Bevestigen</button>
  <button onclick="goBack()">Terug</button>
</div>

<div id="beheer-screen" class="hidden">
  <h2>Beheer</h2>
  <button onclick="showBestellingen()">Bestelgeschiedenis</button>
  <button onclick="showGebruikers()">Gebruikersbeheer</button>
  <button onclick="showVoorraad()">Voorraadbeheer</button>
  <button onclick="showProductToevoegen()">Product toevoegen</button>
  <button onclick="goBack()">Terug</button>
  <div id="beheer-content"></div>
</div>

<script>
const supabase = supabase.createClient(
  "https://nsevcinmxmaplnpyctht.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

let currentUser = null;
let cart = {};
let allProducts = [];
let popupMode = "";

function showPopup(mode) {
  popupMode = mode;
  document.getElementById("popup").classList.remove("hidden");
  document.getElementById("popup-input").value = "";
  document.getElementById("popup-text").textContent = mode === "beheer" ? "Voer admincode in:" : "Voer je gebruikerscode in:";
}

async function handlePopupSubmit() {
  const code = document.getElementById("popup-input").value;
  document.getElementById("popup").classList.add("hidden");

  if (popupMode === "beheer") {
    if (code === "Admin123") {
      showBeheer();
    } else {
      alert("Foutieve admincode.");
    }
  } else {
    const { data: users } = await supabase.from("users").select("*").eq("code", code);
    if (users.length) {
      currentUser = users[0];
      showBestellen();
    } else {
      alert("Gebruikerscode niet gevonden.");
    }
  }
}

function goBack() {
  document.querySelectorAll("div").forEach(div => div.classList.add("hidden"));
  document.getElementById("start-screen").classList.remove("hidden");
}

async function showBestellen() {
  cart = {};
  document.getElementById("start-screen").classList.add("hidden");
  document.getElementById("bestel-screen").classList.remove("hidden");

  const { data } = await supabase.from("products").select("*");
  allProducts = data;

  const grid = document.getElementById("product-grid");
  grid.innerHTML = "";
  data.forEach(prod => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<h4>${prod.name}</h4>
                     <p>Prijs: €${prod.price}</p>
                     <p>Voorraad: ${prod.stock}</p>
                     <button onclick="addToCart(${prod.id})">Toevoegen</button>`;
    grid.appendChild(div);
  });
}

function addToCart(id) {
  const product = allProducts.find(p => p.id === id);
  if (!cart[id]) cart[id] = { ...product, qty: 0 };
  if (cart[id].qty + 1 > product.stock) {
    alert("Onvoldoende voorraad!");
    return;
  }
  cart[id].qty += 1;
  alert(`${product.name} toegevoegd aan winkelwagen`);
  updateCartList();
}

function updateCartList() {
  const ul = document.getElementById("cart-list");
  ul.innerHTML = "";
  Object.values(cart).forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.name} x ${item.qty}`;
    ul.appendChild(li);
  });
}

function adjustOrder() {
  Object.values(cart).forEach(item => {
    const qty = prompt(`Aantal voor ${item.name}:`, item.qty);
    const newQty = parseInt(qty);
    if (!isNaN(newQty)) item.qty = newQty;
  });
  updateCartList();
}

async function confirmOrder() {
  const items = Object.values(cart).filter(i => i.qty > 0);
  if (!items.length) return alert("Geen producten in winkelwagen!");

  let total = 0;
  for (let item of items) {
    const product = allProducts.find(p => p.id === item.id);
    if (product.stock < item.qty) return alert(`Niet genoeg voorraad voor ${item.name}`);
    total += item.price * item.qty;
    await supabase.from("products").update({ stock: product.stock - item.qty }).eq("id", item.id);
  }

  await supabase.from("orders").insert({
    user_code: currentUser.code,
    items: JSON.stringify(items.map(i => ({ id: i.id, name: i.name, qty: i.qty }))),
    total
  });

  alert("Bestelling geplaatst!");
  showBestellen();
}

async function showBeheer() {
  document.getElementById("start-screen").classList.add("hidden");
  document.getElementById("beheer-screen").classList.remove("hidden");
  document.getElementById("beheer-content").innerHTML = "";
}

async function showBestellingen() {
  const { data } = await supabase.from("orders").select("*");
  const grouped = {};

  for (let order of data) {
    if (!grouped[order.user_code]) grouped[order.user_code] = { total: 0, orders: [] };
    grouped[order.user_code].total += order.total;
    grouped[order.user_code].orders.push(order);
  }

  let html = "<h3>Bestellingen</h3><ul>";
  for (let [code, group] of Object.entries(grouped)) {
    html += `<li><strong>${code}</strong>: €${group.total.toFixed(2)}</li>`;
  }
  html += "</ul><button onclick='confirmClearLogs()'>Logs wissen</button>";
  document.getElementById("beheer-content").innerHTML = html;
}

async function confirmClearLogs() {
  if (confirm("Weet je zeker dat je alle logs wilt wissen?")) {
    await supabase.from("orders").delete().neq("id", 0);
    alert("Logs gewist");
    showBestellingen();
  }
}

async function showGebruikers() {
  const { data } = await supabase.from("users").select("*");
  let html = `<h3>Gebruikers</h3><ul>`;
  data.forEach(user => {
    html += `<li>${user.name} (${user.code})
              <button onclick="editUser(${user.id})">Bewerk</button>
              <button onclick="deleteUser(${user.id})">Verwijder</button></li>`;
  });
  html += `</ul><button onclick="addUser()">Gebruiker toevoegen</button>`;
  document.getElementById("beheer-content").innerHTML = html;
}

async function addUser() {
  const name = prompt("Naam:");
  const code = prompt("Gebruikerscode:");
  await supabase.from("users").insert({ name, code });
  showGebruikers();
}

async function editUser(id) {
  const name = prompt("Nieuwe naam:");
  const code = prompt("Nieuwe code:");
  await supabase.from("users").update({ name, code }).eq("id", id);
  showGebruikers();
}

async function deleteUser(id) {
  if (confirm("Verwijder deze gebruiker?")) {
    await supabase.from("users").delete().eq("id", id);
    showGebruikers();
  }
}

async function showVoorraad() {
  const { data } = await supabase.from("products").select("*");
  let html = "<h3>Voorraadbeheer</h3><ul>";
  data.forEach(prod => {
    html += `<li>${prod.name} (voorraad: ${prod.stock})
              <button onclick="updateStock(${prod.id})">Aanpassen</button></li>`;
  });
  html += "</ul>";
  document.getElementById("beheer-content").innerHTML = html;
}

async function updateStock(id) {
  const stock = parseInt(prompt("Nieuwe voorraad:"));
  if (!isNaN(stock)) {
    await supabase.from("products").update({ stock }).eq("id", id);
    showVoorraad();
  }
}

async function showProductToevoegen() {
  const name = prompt("Naam van product:");
  const price = parseFloat(prompt("Prijs:"));
  const stock = parseInt(prompt("Voorraad:"));
  if (name && !isNaN(price) && !isNaN(stock)) {
    await supabase.from("products").insert({ name, price, stock });
    alert("Product toegevoegd");
  }
}
</script>

</body>
</html>
